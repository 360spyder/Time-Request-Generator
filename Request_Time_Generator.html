<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://getbootstrap.com/docs/3.3/dist/css/bootstrap.min.css">

    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/timepicker/1.3.3/jquery.timepicker.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/timepicker/1.3.3/jquery.timepicker.css" />

    <script>
      $( function() {
        $( ".datepicker" ).datepicker({
          changeMonth: true,
          changeYear:  true,
          dateFormat:  'yy/mm/dd',
          onSelect:      timeChange
        });

        $('input.timepicker').timepicker({
          timeFormat: 'HHmm',
          // year, month, day and seconds are not important
          minTime: new Date(0, 0, 0, 6, 0, 0),
          maxTime: new Date(0, 0, 0, 18, 0, 0),
          // time entries start being generated at 6AM but the plugin
          // shows only those within the [minTime, maxTime] interval
          startHour: 6,
          // the value of the first item in the dropdown, when the input
          // field is empty. This overrides the startHour and startMinute
          // options
          startTime: new Date(0, 0, 0, 6, 00, 0),
          // items in the dropdown are separated by at interval minutes
          interval: 30,
          //
          change: timeChange
        });

        if (typeof(Storage) !== "undefined") {
          // Retrieve
          document.getElementById('first_name').value = localStorage.getItem("first_name");
          document.getElementById('last_name').value = localStorage.getItem("last_name");
          document.getElementById('middle_initial').value = localStorage.getItem("middle_initial");
          document.getElementById('prnr').value = localStorage.getItem("prnr");
        }
      });
    </script>
  </head>

  <body height='1300px'>
    <form class="form-horizontal">
      <div class="well" style='background: #EBF4FA;'>
        <div class="row">
          <div class="col-sm-4">
            <div class="form-group">
              <div class="col-sm-4"><div class="control-label">First Name:</div></div>
              <div class="col-sm-8"><input class="form-control" type="text" id="first_name"></div>
              </br>
              </br>
              <div class="col-sm-4"><div class="control-label">Last Name:</div></div>
              <div class="col-sm-8"><input class="form-control" type="text" id="last_name"></div>
              </br>
              </br>
              <div class="col-sm-2 col-sm-offset-2"><div class="control-label">MI:</div></div>
              <div class="col-sm-2"><input class="form-control" type="text" id="middle_initial"></div>
              <div class="col-sm-2"><div class="control-label">PRNR:</div></div>
              <div class="col-sm-4"><input class="form-control" type="text" id="prnr"></div>
            </div>
          </div>
          <div class="col-sm-4">
            <div class="form-group">
              <div class="col-sm-4"><div class="control-label">Leave Type:</div></div>
              <div class="col-sm-8">
                <select id='leave_type' class='form-control'>
                  <option value="LA - Leave Annual">LA - Leave Annual</option>
                  <option value="LS - Leave Sick">LS - Leave Sick</option>
                  <option value="CD - Credit Hours Earned">CD - Credit Hours Earned</option>
                  <option value="CN - Credit Hours Taken">CN - Credit Hours Taken</option>
                  <option value="CE - Comp Time Earned">CE - Comp Time Earned</option>
                  <option value="CT - Comp Time Taken">CT - Comp Time Taken</option>
                  <option value="CB - Comp Travel Earned">CB - Comp Travel Earned</option>
                  <option value="CF - Comp Travel Taken">CF - Comp Travel Taken</option>
                  <option value="TS - Telework">TS - Telework</option>
                </select>
              </div>
              </br>
              </br>
              <div class="col-sm-4"><div class="control-label">Date From:</div></div>
              <div class="col-sm-8"><input class="form-control datepicker" type="text" id="date_from"></div>
              </br>
              </br>
              <div class="col-sm-4"><div class="control-label">Date To:</div></div>
              <div class="col-sm-8"><input class="form-control datepicker" type="text" id="date_to"></div>
            </div>
          </div>
          <div class="col-sm-4">
            <div class="form-group">
              <div class="col-sm-4"><div class="control-label">Hours:</div></div>
              <div class="col-sm-8"><input class="form-control" type="text" id="hours"></div>
              </br>
              </br>
              <div class="col-sm-4"><div class="control-label">Time From:</div></div>
              <div class="col-sm-8"><input class="form-control timepicker" type="text" id="time_from"></div>
              </br>
              </br>
              <div class="col-sm-4"><div class="control-label">Time To:</div></div>
              <div class="col-sm-8"><input class="form-control" type="text" id="time_to" readonly='true'></div>
            </div>
          </div>
        </div>
        <div class='row'>
          <div class='col-sm-12'>
            <div class="form-group">
              <div class='col-sm-2'><div class='control-label'>Reason for Leave:</div></div>
              <div class="col-sm-8"><textarea class="form-control" id="reason" rows="3"></textarea></div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-sm-2 col-sm-offset-5">
            <div class="text-center"><a class="btn btn-primary btn-block" href='#' onClick="javascript:return generate()">Generate</a></div>
          </div>
        </div>
      </div>
      <div class='container'>
        <div class="well">
          <table class='table'>
            <tr>
              <th>Subject:</th>
              <td><div id='subject'></div><input id='subject_copy' style='display: none' type='text'></td>
              <td><button class='pull-right' type='button' onclick="copySubject()"><span class='glyphicon glyphicon-copy'></span></button></td>
            </tr>
            <tr>
              <th>Body:</th>
              <td><div id='body'></div></td>
              <td><button class='pull-right' type='button' onclick="copyBody()"><span class='glyphicon glyphicon-copy'></span></button></td>
            </tr>
          </table>
        </div>
      </div>
    </form>
  </body>
  <footer style='position: auto; bottom: 0; width: 100%;'>
    <hr>
    <div class='well' style='background: #000; color: #FFF;'>
    <div class='container'>
      <div class='row'>
        <div class='col-sm-4'>SPAWAR Request Time Generator</div>
        <div class='col-sm-4'><div class='text-center'>Christopher Nuhn - christopher.nuhn@navy.mil</div></div>
        <div class='col-sm-4'><a class='pull-right' href='https://github.com/360spyder/Time-Request-Generator'>Version 0.9 Beta!</a></div>
      </div>
    </div>
    </div>
  </footer>
  <script>
    function generate() {
      var first_name = document.getElementById('first_name').value.toUpperCase();
      var last_name = document.getElementById('last_name').value.toUpperCase();
      var middle_initial = document.getElementById('middle_initial').value.toUpperCase();
      var PRNR = document.getElementById('prnr').value;

      var reason = document.getElementById('reason').value;
      var leave_type = document.getElementById('leave_type').value;
      var hours = document.getElementById('hours').value;

      var date_from = document.getElementById('date_from').value.split('/').join('');
      var date_to = document.getElementById('date_to').value.split('/').join('');
      var d = new Date(document.getElementById('date_from').value);
      var saturday = `${date_from.slice(0,6)}${parseInt(date_from.slice(-2)) + (6 - d.getDay())}`;

      var time_from = document.getElementById('time_from').value;
      var time_to = document.getElementById('time_to').value;

      document.getElementById('subject').innerHTML = `${PRNR}_${last_name}_${first_name}_${middle_initial}_${saturday}_${leave_type.slice(0,2)}_${hours}HRS`;
      document.getElementById('body').innerHTML = `
        Request for ${leave_type.slice(5)}</br>
        ${(reason != '') ? reason.replace(/(?:\r\n|\r|\n)/g, '</br>') + '</br>': ''}
        </br>
        <table>
          <tr>
            <td>PRNR:</td>
            <td>${PRNR}</td>
          </tr>
          <tr>
            <td>Date From:</td>
            <td>${date_from}</td>
          </tr>
          <tr>
            <td>Date To:</td>
            <td>${date_to}</td>
          </tr>
          <tr>
            <td>Time From:</td>
            <td>${time_from}</td>
          </tr>
          <tr>
            <td>Time To:</td>
            <td>${time_to}</td>
          </tr>
          <tr>
            <td>Hours:</td>
            <td>${hours}</td>
          </tr>
          <tr>
            <td>Leave Type:</td>
            <td>${leave_type.slice(0,2)}</td>
          </tr>
        </table>
        </br>
        [LA - Annual, LS - Sick, CD - Credit Earned, CN - Credit Taken, CB - Travel Comp Earned, CF - Travel Comp Taken]
      `;

      if (typeof(Storage) !== "undefined") {
        // Store
        localStorage.setItem("first_name", first_name);
        localStorage.setItem("last_name", last_name);
        localStorage.setItem("middle_initial", middle_initial);
        localStorage.setItem("prnr", PRNR);
      };

      return false;
    };
  </script>
  <script>
    document.getElementById('hours').addEventListener("change", timeChange);
    document.getElementById('leave_type').addEventListener("change", generate);

    function timeChange() {
      var time_from = parseInt(document.getElementById('time_from').value);
      var date_from = new Date(document.getElementById('date_from').value);
      var date_to = new Date(document.getElementById('date_to').value);

      //Return if Dates are invalid
      if (isNaN(date_from.getTime()) == true){document.getElementById('time_to').value = "A Date From is Invalid"; return;};
      if (isNaN(date_to.getTime()) == true){document.getElementById('time_to').value = "A Date To is Invalid"; return;};

      var oneDay = 24*60*60*1000; // hours*minutes*seconds*milliseconds
      var days = Math.round(Math.abs((date_from.getTime() - date_to.getTime())/(oneDay))) + 1;
      var total_hours = parseFloat(document.getElementById('hours').value);
      var hours_per_day = (total_hours / days).toString();
      var hours = hours_per_day.split('.')[0] * 100

      if (hours_per_day.split('.').length == 2) {
        var minutes = Math.round(parseInt((hours_per_day.split('.')[1] + '0').slice(0,2)) / 10 * 6);
      } else {
        var minutes = 0;
      };

      //Return if Time invalid
      if (isNaN(hours) == true || isNaN(minutes) == true){document.getElementById('time_to').value = "A Hours is Invalid"; return;};

      if (parseInt((time_from + minutes).toString().slice(-2)) >= 60) {
        alert(time_from + hours + 100 + (minutes - 60))
        var new_time = time_from + hours + 100 + (minutes - 60);
      } else {
        var new_time = time_from + hours + minutes;
      };
      document.getElementById('time_to').value = ('0000' + new_time).slice(-4);
      generate();
    };
  </script>
  <script>
    function copySubject() {
      var subject = document.getElementById('subject').innerHTML;
      tmp = document.createElement('TEXTAREA');
      tmp.value = subject;
      document.body.appendChild(tmp);
      tmp.select();
      document.execCommand("Copy");
      document.body.removeChild(tmp);
      return false;
    };
    function copyBody() {
      var body = document.getElementById('body').innerHTML;
      body = body.replace(/\s{2,}/g, '');
      body = body.replace(/<br>|<tr>/g, '\r\n');
      body = body.replace(/<\/td>/g, '\t');
      body = body.replace(/<(\/*table|\/*tbody|\/*td|\/*tr)>/g, '');

      tmp = document.createElement('TEXTAREA');
      tmp.value = body;
      document.body.appendChild(tmp);
      tmp.select();
      document.execCommand("Copy");
      document.body.removeChild(tmp);
      return false;
    };
  </script>
</html>
